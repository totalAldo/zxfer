# TODO – Logical Bugs

- [ ] `src/zxfer_transfer_properties.sh:431` checks whether the destination dataset already exists by piping `$g_actual_dest` straight into `grep -c "^…$"` without escaping regex metacharacters. Dataset names regularly contain dots or other regex characters, so entries like `backup/foo.bar` match `backup/fooXbar` and zxfer wrongly assumes the dataset exists, skipping the creation path and later failing when `zfs get` is run on a dataset that was never created. Escape the dataset name (similar to how snapshot paths are normalized elsewhere) before building the regex.
- [ ] `src/zxfer_get_zfs_list.sh:333-365` aborts when the root destination dataset does not yet exist because it treats the empty output from `zfs list -t filesystem,volume … "$g_destination"` as a fatal error (`throw_usage_error "Failed to retrieve list of datasets from the destination"`). That prevents zxfer from bootstrapping into a brand-new destination even though later stages (`transfer_properties()` and `zfs_send_receive()`) can create the missing datasets on demand. `get_zfs_list()` should tolerate an empty destination list instead of exiting.
- [ ] `src/zxfer_get_zfs_list.sh:43-45` performs `[ "$g_option_j_jobs" -le 1 ]` before validating that the `-j` argument is numeric. Passing a non-integer such as `-j foo` causes `/bin/sh` to emit “integer expression expected” and zxfer dies before emitting a helpful usage error. Validate the CLI input (e.g., via a pattern check) before touching it in arithmetic contexts so invalid values can be rejected cleanly.
- [ ] Destination paths with a trailing slash are never normalized, so `set_actual_dest()` (`src/zxfer_zfs_mode.sh:51-72`) concatenates `$g_destination` and the child dataset with an extra `/`. Invocations such as `zxfer -N tank/src backup/dst/` therefore generate targets like `backup/dst//src`, which `zfs` rejects as invalid dataset names. The source path is stripped of trailing slashes in `run_zfs_mode()` (`src/zxfer_zfs_mode.sh:316-325`); the destination should be normalized the same way before replication starts.
