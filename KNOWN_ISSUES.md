# TODO – Logical Bugs

- **Remote metadata helpers drop host-spec tokens** – Several ssh call sites still pass the entire `-O`/`-T` host spec as a single quoted argument (see `src/zxfer_globals.sh:524`, `src/zxfer_globals.sh:775`, `src/zxfer_globals.sh:852`, `src/zxfer_globals.sh:977`). When the user appends privilege wrappers such as `pfexec` or additional ssh options, these functions treat the whole string as the hostname, so `ensure_remote_backup_dir`, property backup writes, and restore readers fail before running their commands. Other modules already use `quote_host_spec_tokens`; these helpers need to split/quote the host spec consistently before invoking ssh.
- **Recursive runs skip property/backup work when datasets are already in sync** – `set_g_recursive_source_list()` only tracks datasets with missing snapshots (`src/zxfer_get_zfs_list.sh:223-265`), and `copy_filesystems()` iterates exclusively over that list (`src/zxfer_zfs_mode.sh:253-294`). When recursion finds no deltas, `transfer_properties()` never runs and `g_backup_file_contents` stays empty, yet `write_backup_properties()` still overwrites `.zxfer_backup_info.*` with just the header (`src/zxfer_globals.sh:959-980`). As a result `-P/-o` flags cannot enforce property changes on already-synced datasets and `-k` wipes prior metadata. The property/backup pass should still run (or file writes should be skipped) even when no snapshots need sending.


# TODO – Security Review

- [ ] `src/zxfer_globals.sh:118-138` – zxfer resolves `awk`, `zfs`, `ssh`, `parallel`, and other critical helpers via `which` and inherits whatever `PATH` the caller exposes. When zxfer runs as root (common during replication), any untrusted directory prepended to `PATH` allows a local attacker to drop a trojan binary that gets executed before the real system tool. Sanitize the execution environment up front (e.g., reset `PATH` to trusted directories or resolve each binary via a constant absolute path) so privilege escalation via path hijacking is impossible.
- [ ] `src/zxfer_globals.sh:738-835` – Property restores (`-e`) trust whichever `.zxfer_backup_info.*` file is found in `ZXFER_BACKUP_DIR` and only reject symlinks. There is no ownership or permission check before ingesting the file contents, even though those entries drive property changes like `mountpoint`, `sharenfs`, or encryption metadata. If the secure backup directory ever ends up group-writable (for example, mounted over shared storage), a less-privileged user can poison the metadata and coerce zxfer to reconfigure datasets on the next restore. Add explicit owner/permission verification before reading backup files and refuse to proceed when they are not root/0600.
