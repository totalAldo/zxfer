CHANGELOG
=========

2025.11.19
-Ensure `-d` deletion passes walk every dataset even when no new snapshots are pending so orphaned destination snapshots are proposed/destroyed during dry-run and live zxfer runs, and cover the copy loop behavior via new shunit2 tests.

2025.11.18
-Fix ssh control socket initialization to create temp directories with mktemp-compatible templates (suffix `XXXXXX`) so Linux and GNU coreutils builds no longer abort zxfer or the shunit2 probe when -O/-T opens a control socket.
-Add `tests/run_shunit_tests.sh` to execute every shunit2 suite (or a specific subset) from one command so contributors can easily exercise helpers like `test_zxfer_zfs_mode.sh` without remembering individual scripts.
-Expand `tests/test_zxfer_zfs_mode.sh` coverage for `set_actual_dest()`, `refresh_dataset_iteration_state()`, grandfather protection, and the `-Y` run loop so option parsing and migration orchestration stay regression-tested.
-Refactor snapshot listing orchestration (`write_source_snapshot_list_to_file()`, `write_destination_snapshot_list_to_files()`, `set_g_recursive_source_list()`) into data-flow helpers that build the source command string, normalize destination prefixes, and diff sorted lists so background jobs no longer embed inline eval plumbing, enabling shunit2 coverage of ssh/parallel/compression permutations without touching live ZFS.
-Quote the per-dataset GNU parallel runner with literal single quotes so remote shells that default to `/bin/csh` no longer emit repeated `Unmatched '"'` errors when `-O` and `-j` are used together, stop escaping the `$1` placeholder so dataset arguments reach the per-dataset `zfs list`, and add shunit2 coverage to guard the new quoting.
-Refactor `transfer_properties()` into composable helpers (source property collection, override derivation, destination diff/apply) and add shunit2 coverage with injectable set/inherit runners so safety-sensitive property logic can be unit-tested without touching real pools.
-Allow zxfer to treat backup directories and metadata files owned by the invoking user as secure when root privileges are unavailable (while still enforcing 0700/0600 permissions) so shunit2 and CI runs on Linux can exercise the helpers without failing ownership checks.
-Run recursive property/backup passes even when every dataset is already in sync so -P/-o/-k still enforce metadata, and skip writing `.zxfer_backup_info.*` files when no property data was captured to avoid clobbering prior backups.
-Reset PATH to `/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin`, resolve required binaries to their absolute paths, and teach zxfer to honor `ZXFER_SECURE_PATH[_APPEND]` so PATH hijacking is no longer possible when zxfer runs with elevated privileges.

2025.11.17
-Reject non-numeric `-j` arguments during option parsing so invalid job counts emit a zxfer usage error instead of `/bin/sh: integer expression expected` later on.
-Allow zxfer to bootstrap into brand-new destinations by tolerating an empty `zfs list -t filesystem,volume … "$g_destination"` result instead of aborting when no datasets exist yet on the target.
-Refuse to use zxfer backup metadata directories unless they are owned by root locally or by the remote ssh user (root also permitted) so attackers cannot pre-create `ZXFER_BACKUP_DIR` paths and retain ownership of `.zxfer_backup_info.*` files.
-Require property restores (-e) to read `.zxfer_backup_info.*` files only when they are root-owned and mode 0600 so compromised backup directories cannot poison mountpoint, sharing, or encryption metadata.
-Quote -O/-T ssh host specs before constructing eval'd pipelines and open/close ssh control sockets without eval so a crafted host argument can no longer inject local commands before ssh starts.
-Treat `-Z/ZXFER_COMPRESSION` strings as tokenized commands and refuse empty compression pipelines so attacker-controlled configs cannot splice arbitrary shell syntax into the send/receive ssh pipelines.
-Create zxfer progress FIFOs with umask 077 and chmod 600 so local users cannot read or stall the replicated send stream via /tmp/zxfer-progress.*
-Quote the progress passthrough hook with single quotes so remote `-O -D` pulls keep the ssh command coherent and progress works on origin hosts.
-Estimate incremental stream sizes when a previous snapshot exists so the progress dialog reflects the bytes that will actually be sent.
-Keep g_is_performed_send_destroy unset during dry-run sends so `-Y -n` exits after the first loop when no mutations occur.
-Eliminate command injection in transfer_properties() by building `zfs create` argument lists without eval so property values are passed verbatim even when the destination dataset does not yet exist.
-Fail replication immediately when any background `-j` zfs send/receive job exits non-zero by tracking their PIDs, surfacing failures, and terminating the remaining jobs instead of silently reporting success.
-Store `.zxfer_backup_info.*` metadata under a root-owned `ZXFER_BACKUP_DIR` (default `/var/db/zxfer`), harden directory creation against symlinks, and warn when falling back to legacy files so attackers can no longer pre-create mountpoint symlinks to clobber arbitrary files during `-k`.
-Ensure the -D progress hook tees the send stream so non-pass-through progress commands no longer truncate the data before `zfs receive`.
-Seed existing destination datasets that have no snapshots by sending the first snapshot before incremental streams so pre-created replicas keep their full history instead of only the newest snapshot.
-Gate the beep() helper on FreeBSD speaker support so Linux/OpenZFS hosts skip hardware beeps gracefully instead of aborting when -b/-B is set.
-Resolve GNU parallel via ssh for -j snapshot listings so remote -O hosts no longer reuse the local path and abort when the binary lives elsewhere, and refuse -j when the remote binary is missing.
-Eliminate command injection in write_backup_properties() by streaming raw property data directly into the backup file and expand shunit2 coverage for the helper
-Normalize destination snapshot prefixes for non-trailing-slash transfers so dataset detection matches pre-2025.11.14 behavior, while keeping trailing-slash multi-host replicas isolated.
-Strip trailing slashes from destination dataset arguments before replication so `zxfer -N tank/src backup/dst/` no longer builds illegal `backup/dst//child` targets that `zfs receive` rejects.
-Filter source/destination snapshot lists by exact dataset names when building replication plans so nested filesystems that share a basename (for example, trailing “/tank”) no longer collide when computing the last common snapshot.
-Wrap the GNU parallel snapshot listing commands in `sh -c` and pass dataset names as `$1` arguments so per-dataset jobs execute `/sbin/zfs list … "$1"` with proper argument splitting even when datasets contain slashes or spaces, fixing both local and remote `-O` listing.

2025.11.15
-Destination snapshot lookup now respects trailing-slash sources so incremental sends compare against the correct dataset
-Track fully qualified last-common snapshot
-Escape dataset names before sed substitution
-Fix GNU parallel snapshot listing
-Restore trailing-slash destination handling
-Literalize snapshot prefix matching
-Fix integration multi-dataset replication
-remove the legacy rsync (-S) mode and delete unused options and helpers
-drop the rsync dependency from zxfer.spec and refresh the man pages/README
-update integration tests and scripts now that rsync transfer paths no longer exist
-vendor shunit2 test harness and helper script
-add zxfer_common shunit2 smoke tests and make them executable
-document how to run the new shunit2 tests
-add GitHub Actions workflow to run shunit2 tests on pushes and PRs
-fix get_temp_file mktemp template to work on GNU/Linux CI runners
-exclude vendored tests/shunit2 from codespell checks
-add integration test script that provisions loopback ZFS pools for zxfer smoke tests
-add shfmt formatting gate to lint workflow
-multiple lint fixes
-Add lint workflow for codespell & ShellCheck
-fix shellcheck warnings
-source files for shellcheck
-add .shellcheckrc
-Fixed handling of filtered destination properties in transfer_properties
-Use argument in newsnap instead of global initial_source
-Fix -m migration guard to reject unmounted sources

2025.11.14
-spelling fixes
-copyright year update
-Secure ssh control socket creation
-Ensure -o overrides get applied in transfer_properties
-fix misspelling of throw_error in transfer_properties
-Handle local vs remote backup writes correctly
-Fix remote property restore lookup
-Resolve cat path correctly for local property restores
-Filter existing-destination property list correctly
-Manage ssh control sockets per host
-Fix property/rsync command injection
-update zxfer.spec file
-document zxfer.8 option restrictions and compression requirements
-sync zxfer.1m with zxfer.8

2024.09.20
-fix bug in transfer_properties() where the source dataset was not being properly set

2024.09.19
-add -x option to exclude datasets that match the given grep pattern

2024.08.04
-fix an issue with copying the first snapshot when a destination dataset doesn't
 exist

2024.08.03
-add very verbose output to display snapshot deltas in set_g_recursive_source_list()
-clean up copy_snapshots()

2024.08.01
-commented out parallel use for listing destination due to poorer performance
 when metadata cached
-add parallel support when listing destination snapshots

2024.07.29
-update zfs list for IllumOS to use '-d 1' when listing snapshots
-only pipe parallel output through zstd if compression is enabled
-add exists_destination() to check if destination dataset exists
-update trap_exit() to quit child processes and exit with proper exit code

2024.07.28
-add g_cmd_parallel variable to use which to locate path to parallel
-sort g_recursive_source_list to properly create datasets
-fix bug where if destination dataset does not exist, only the last snapshot
 is sent. Now, the first snapshot is sent and then the full snapshot range
 is sent.
-fix listing destination snapshots when pushing via ssh

2024.07.27
-parallelize the comparison of snapshots to deleted
-use global temporary files for snapshot deletion
-refactor zfs_get_list()
-code cleanup

2024.07.26
-use ssh control socket for all ssh connections

2024.07.24
-rename -x option to -j for number of parallel jobs

2024.07.23
-run zfs send operations as background processes (later limited to -j #jobs)

2024.07.21
-optimize grep calls by passing -m 1 (later removed for Illumos compatibility)

2024.07.16
-add use of gnu parallel to list source snapshots ordered by creation
-remove creation of one temporary file

2024.07.15
-add -x option to specify number of parallel jobs for zfs list

2024.07.12
-batch zfs destroy commands
-optimize zfs list on destination snapshots by removing sorting

2024.07.10
-optimize get_zfs_list() by only listing snapshots of the intended destination
 dataset instead of listing all the snapshots of the parent destination dataset

2024.04.09
-add consistency check for -Y option

2024.04.08
-add -Y (Y)ield command that runs run_zfs_mode up to a maximum of 8 times
 while there are zfs send or zfs destroy commands that are executed

2024.04.06
-fix bug in get_zfs_list() when 2 snapshots are taken at the same time
-optimize grep usage in set_last_common_snapshot

2024.04.03
-run zfs destroy as a background process

2024.03.31
-add option -w for zfs raw send

2024.03.19
-copy_snap_mulitple now sends one snapshot range and set_send_command
 switched from zfs send -i to zfs send -I

2024.03.14
-refactor script into multiple files, grouping files by function usage

2024.03.13
-remove unused variables in get_zfs_list() and clean it up
-prefix global variables with g_ and local variables with l_

2024.03.12
-refactor get_zfs_list() to run zfs list commands in the background to reduce
 the time it takes to get the list of filesystems
-add -V option for (V)ery verbose mode using echoV()
-optimize set_last_common_snapshot() by using grep instead of nested loops
-add echoV statements for debugging

2024.03.11
-refactor inspect_delete_snap() into multiple functions with the primary goal
 of optimizing the snapshot deletion logic. Convert that from nested loops
 to using temp files and comm for a more efficient comparison.

2024.03.09
-add -z option to use zstd compression
-add -Z option to specify the zstd compression command
-refactor of the code
-add execute_command() function
-add throw_error functions
-refactor copy_snap()
-rename option variables for readability
-wrap long blocks in functions to improve readability
-update verbose messages to display the command being executed
-group functions by mode

2024.03.06
-Fork of zxfer to totalAldo/zxfer

20110513 ver 0.9.9
           -Fixed a small but showstopping bug in Solaris that wasn't showing
	     up in FreeBSD. Thanks predrag....@googlemail.com. Because this
	     is the only fix and is not affecting FreeBSD, I may not update
	     the port until the next version.
20110510 ver 0.9.8
           -Added -c option to default rsync options list. Note that this
	     much increases reliability of backups, at the expense of speed.
	   -Removed --del option when transferring single files with -N.
           -Fixed bug in rsync transfer, where --del option caused
	     attempted deletes of filesystem mountpoints on destination.
           -Made the grandfather protection option check everything BEFORE
	     any deletions would occur. If grandfathers are being deleted,
	     chances are something is wrong, so better to fail before doing
	     damage.
	   -Added a "p" switch to persist in face of rsync errors. Needed
	     for a full system restore.
	   -Added an "E" to enable passing of excludes to rsync (useful
	     for avoiding transfer of zpool.cache)
	   -Added an "i" option to enable inclusion of filesystem mountpoints
	     on the destination in -S mode, as they needed to be excluded
	     by default.
	     If they aren't excluded then --del will wipe anything there,
	     e.g. contents from a filesystem from another pool.
20110407 ver 0.9.7
           -Removed the extra backup related content from the man page
             as more suitable for external documentation. KISS.
	   -Added in a "grandfather protection" option [-g], to prevent
	     grandfather snapshots being deleted inadvertently.
20110405   -Again, added to and modified the man page significantly, to
              explain tape vs HDD backup.
20110404   -Made zxfer more portable, by testing for the actual $PATH via
             "which" instead of guessing which directories the programs might
	     live in.
20110402 ver 0.9.6
           -Added a section "SNAPSHOTS" to the man page, to express that
             zxfer is designed to work with snapshots, and how it does so.
	   -Made zxfer use awk in FreeBSD, gawk in Solaris, so that there
	     is only the rsync dependency remaining for purpose of porting.
20110331 ver 0.9.5
           -Changed download package to have a directory within, to suit ports.
20110331 ver 0.9.4
           -Some refactoring, updating man page, and testing to make
             it work better on S11E.
20110329 ver 0.9.3
           -Tested local transfers on FBSD 8.2 and SE11. Tested remote
             transfers on FBSD 8.2.
	   -Updated the man page.
20110328   -Implemented the -O and -T remote transfer options. Tested on
             FreeBSD somewhat.
20110327 ver 0.9.2
           -Added "Compatibility" section to man page.
           -Added to the man page a warning not to tack switches with arguments
             on the end of a list of switches without arguments.
	   -Alphabetized the options in the man page, and in the script.
20110323   -Started fixing a bug so that zxfer can work with remote hosts via
             ssh.
	   -Added "vscan,nbmand" to the list of properties not supported
	     by FreeBSD.
20110321   -Added "xattr" to list of properties not supported on FreeBSD,
             so that zxfer works on FreeBSD 8.2 out of the box.
	   -Changed the beep option, breaking backwards compatibility for
	     the sake of having more logical switches. The B is a "big beep",
	     alerting the user for success or failure. The b is a "small beep"
	     that will only sound on error.
20101211 ver 0.9.0 -Added some output for errors.
           -Added proviso to man page about backing up/restoring FreeBSD
	     root directories.
           -Familiarized self with mercurial workflow in anticipation of
	     publishing.
           -Fixed several Solaris compatibility bugs.
           -Added /usr/bin as rsync location
	   -Changed awk to gawk
	   -mlslabel transferring is not supported at this stage.
	   -ditto for keysource,keystatus,rekeydate,encryption.
	   -OpenSolaris wasn't handling 3 pipes in a single line, reduced
	    to maximum of 2 and it works.
20101127 ver 0.8.3 A week trialing zxfer on the workstation in active use
             pays off. Not all snapshots were transferring with zfs send
	     based zxfers. Needless to say, very glad it's squashed.
	   -Also added a beep (-b) feature, to alert when zxfer finishes.
	   -Finished tweaking and testing the man page for easy conversion
	     to Solaris format (using mdoc2man.awk).
20101117 ver 0.8.2 Nearly ready, just needs Solaris man page.
           -Location of rsync is searched for at the start.
20101115 ver 0.8.1 Ready to release?
           -Finished testing on all of the examples in the man page.
           -Added the ability to specify snapshots to use as a base
	     for rsync (option "u").
	   -Changed the default rsync options (see man page).
20101013 ver 0.8.0 First "near final" draft sent to Constantin.
           In the intervening time, many changes have taken place.
	   zxfer is chosen as the new name. Some of the additional features:
	   -recursive transfers
	   -property and property source transfer of ZFS filesystems -
	     creation and setting
	   -property overrides (e.g. for compression, dedup, copies etc.)
	   -an rsync mode, for copying arbitrary files and directories
	     from within a pool atomically
	   -property backup mode, to allow the future restore of properties
	     while retaining the ability to back them up with different
	     properties than they would otherwise have, e.g. compression etc.
	   -removed the ksh dependency
	   -a man page
	   -much bug testing
20100504 Dreckman worked on a bug fix and some additions to
           zfs-replicate; these are submitted to CG. At this stage
	   the additions are already fairly extensive, so Contantin kindly
	   suggested that the new version become a new utility in its
	   own right. Collaboration commenced between the two with
	   Constantin offering helpful guidance throughout as Dreckman coded
	   new features and squashed bugs.
20080813 zfs-replicate 0.7 is released by Constantin Gonzalez as the
           last update in his zfs-replicate utility. This may be found at
         http://blogs.sun.com/constantin/entry/zfs_replicator_script_new_edition
