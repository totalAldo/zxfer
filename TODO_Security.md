# TODO – Security Review

- [ ] **Command injection when writing property backups** (`src/zxfer_globals.sh:565`)
  - `write_backup_properties()` builds a shell command such as `echo "$g_backup_file_contents" | tr ";" "\n" > …` and feeds it to `sh -c`. The `$g_backup_file_contents` blob contains raw property names and values pulled from the (potentially remote) source dataset (`src/zxfer_transfer_properties.sh:252`). Any property value containing command substitutions, backticks, or shell metacharacters (`$()`, `` ` ``, `;`, etc.) is therefore executed locally with zxfer’s privileges when the backup file is written. A malicious source can trigger RCE simply by setting a user property like `zfs set user:note='$(touch /tmp/pwn)' pool/fs` before replication and running zxfer with `-k`.
  - **Impact:** Remote source (or anyone who can set properties on it) gains arbitrary command execution on the host running zxfer whenever property backups are enabled.
  - **Fix:** Stop passing opaque strings through `sh -c`. Write the file by piping through `printf '%s' "$g_backup_file_contents"` (no extra quoting) directly into `tr` and redirecting with a safely quoted destination path, or write via a temporary file opened with shell redirection handled by the current process. Ensure the property blob is treated as pure data rather than an executable script.

- [ ] **Arbitrary file clobber via backup file path** (`src/zxfer_globals.sh:555-585`)
  - The same `write_backup_properties()` routine writes its output to `$mountpoint/.zxfer_backup_info.$dataset`, where `mountpoint` is pulled verbatim from the destination dataset. Those mountpoints frequently correspond to user-writable trees (think `/home` or shared SMB exports), so any local user with access can pre-create `.zxfer_backup_info.<tail>` as a symlink to `/etc/passwd`, `/root/.ssh/authorized_keys`, etc. When root later runs `zxfer -k`, the `sh -c "… > path"` redirection follows the symlink and overwrites the attacker’s chosen file with zxfer’s metadata, yielding privilege escalation or at minimum a destructive DoS.
  - **Impact:** A non-privileged user who can write inside the destination mountpoint can coerce zxfer to overwrite arbitrary files on the replication host the next time properties are backed up.
  - **Fix:** Never write backups inside user-writable trees without hardening the path. Store the files in a root-owned directory (e.g., `/var/db/zxfer`) or create them with `mktemp` and `mv` after validating that the destination is not a symlink/hard link (`[ -h "$path" ]`/`[ ! -e "$path" ]`). At minimum, open the file directly (no `sh -c`) and refuse to proceed unless the target is an existing regular file owned by root.

- [ ] **Command injection while creating destination datasets** (`src/zxfer_transfer_properties.sh:386` and `src/zxfer_transfer_properties.sh:425`)
  - When the destination dataset does not yet exist, `transfer_properties()` converts the source property list (and any `-o` overrides) into `override_option_list`/`creation_option_list` by wrapping each value in single quotes and then runs `eval "$g_RZFS create … $g_actual_dest"` (lines `src/zxfer_transfer_properties.sh:405` and `src/zxfer_transfer_properties.sh:442`). Property values come directly from `zfs get` on the source, so they can contain arbitrary characters, including single quotes or shell syntax. A crafted value such as `foo'; touch /tmp/pwn #'` breaks out of the quoted segment and injects an arbitrary command that runs as soon as zxfer tries to create the destination dataset.
  - **Impact:** Any source dataset (or even a user-provided `-o property=value`) can execute arbitrary shell commands on the system receiving the replication before any ZFS operations complete.
  - **Fix:** Eliminate `eval` here. Build the `zfs create` command using proper quoting—e.g., accumulate options in an array and pass them to `"$g_RZFS" create "$@"`—or escape single quotes inside values before interpolating them. Without executing the string via `eval`, property values remain data and cannot terminate the command prematurely.
